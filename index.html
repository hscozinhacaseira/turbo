<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Assistente de Vendas - MDTURBOS</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{--primary:#1d3557;--accent:#e63946;--muted:#666}
    html,body{height:100%;margin:0}
    body { font-family: 'Roboto', sans-serif; background-color: #f0f2f5; display:flex; justify-content:center; align-items:center; min-height:100vh; padding:12px; }
    #chat-container { width:500px; max-width:100%; height:700px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.12); display:flex; flex-direction:column; overflow:hidden; background:#fff; }
    #chat-header { background:linear-gradient(90deg,var(--primary),#457b9d); color:#fff; padding:16px; text-align:center; font-weight:700; font-size:1.05rem; border-bottom:4px solid var(--accent); }
    #chat-messages { flex:1; padding:12px; overflow-y:auto; display:flex; flex-direction:column; gap:10px; }
    .message { padding:8px 12px; border-radius:14px; max-width:92%; line-height:1.35; word-wrap:break-word; }
    .bot-message { background:#eef2f6; color:#111; align-self:flex-start; border-bottom-left-radius:6px; }
    .bot-message pre{white-space:pre-wrap;margin:0;font-family:inherit;font-size:0.92rem}
    .user-message { background:var(--primary); color:#fff; align-self:flex-end; border-bottom-right-radius:6px; }
    #chat-form { display:flex; border-top:1px solid #eee; padding:10px; gap:8px; }
    #chat-input { flex:1; border:1px solid #ddd; border-radius:20px; padding:10px 14px; font-size:1rem; outline:none; }
    #send-button { background:var(--accent); border:none; color:#fff; padding:0 14px; border-radius:20px; font-weight:700; cursor:pointer; }
    .product-card { background:#fff; border:1px solid #e6e6e6; padding:10px; border-radius:8px; margin-top:6px; }
    .product-actions { margin-top:8px; display:flex; gap:8px; }
    .btn { padding:6px 10px; border-radius:6px; border:none; cursor:pointer; }
    .btn-select { background:var(--primary); color:#fff; }
    .btn-info { background:#f6f6f6; color:#333; }
    .spinner { display:inline-block; width:16px; height:16px; border:3px solid rgba(0,0,0,0.08); border-left-color:var(--primary); border-radius:50%; animation:spin .8s linear infinite; vertical-align:middle; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .muted { color:var(--muted); font-size:0.95rem; }
    /* responsive */
    @media (max-width:420px){ #chat-container{height:92vh} }
  </style>
</head>
<body>
  <div id="chat-container" role="application" aria-label="Assistente de vendas MDTURBOS">
    <div id="chat-header">Agente de Vendas N1 — MDTURBOS</div>
    <div id="chat-messages" aria-live="polite" aria-atomic="false"></div>
    <form id="chat-form" autocomplete="off">
      <input id="chat-input" type="text" placeholder="Digite sua mensagem..." />
      <button id="send-button" type="submit">Enviar</button>
    </form>
  </div>

  <script>
    // Modo de execução: Apps Script (google.script.run) OR estático (fetch CSV).
    const isAppsScript = typeof google !== 'undefined' && typeof google.script !== 'undefined' && typeof google.script.run === 'function';
    const CSV_PATH = 'ESTOQUE_limpo.csv'; // para hospedagem estática
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');

    let conversationState = 'START';
    let lastFoundProducts = [];
    const userData = { nome:'', celular:'', produto:null };

    function el(text, cls='bot-message') {
      const d = document.createElement('div'); d.className = 'message ' + cls; d.textContent = text; return d;
    }
    function htmlEl(html, cls='bot-message') {
      const d = document.createElement('div'); d.className = 'message ' + cls; d.innerHTML = html; return d;
    }
    function botSay(text, isHtml=false) {
      const node = isHtml ? htmlEl(text, 'bot-message') : el(text, 'bot-message');
      chatMessages.appendChild(node); chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    function userSay(text) {
      const node = el(text, 'user-message'); chatMessages.appendChild(node); chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function renderProductCard(p, idx) {
      const wrap = document.createElement('div'); wrap.className = 'bot-message';
      const card = document.createElement('div'); card.className = 'product-card';
      const title = document.createElement('strong'); title.textContent = `${idx+1}. ${p.Nome_Produto}`;
      const pre = document.createElement('pre'); pre.textContent = `PN: ${p.PN_Alternativos}\nModelo: ${p.Modelos}\nMedidas: ${p.Medidas}\nEstoque: ${p.Estoque}`;
      const actions = document.createElement('div'); actions.className = 'product-actions';
      const btnSelect = document.createElement('button'); btnSelect.type='button'; btnSelect.className='btn btn-select'; btnSelect.textContent='Selecionar';
      btnSelect.addEventListener('click', ()=> processProductSelection(p));
      const btnInfo = document.createElement('button'); btnInfo.type='button'; btnInfo.className='btn btn-info'; btnInfo.textContent='Ver mais';
      btnInfo.addEventListener('click', ()=> { botSay(JSON.stringify(p, null, 2)); });
      actions.appendChild(btnSelect); actions.appendChild(btnInfo);
      card.appendChild(title); card.appendChild(pre); card.appendChild(actions);
      wrap.appendChild(card);
      chatMessages.appendChild(wrap); chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function processProductSelection(product) {
      userData.produto = product;
      if (Number(product.Estoque) > 0) {
        botSay(`Ótima escolha! O item "${product.Nome_Produto}" está disponível. Temos ${product.Estoque} unidades.`);
        botSay(`Posso gerar um orçamento para você? (sim/não)`);
        conversationState = 'CONFIRM_ORCAMENTO';
      } else {
        botSay(`O item "${product.Nome_Produto}" está indisponível no momento. Quer que um vendedor verifique prazo de reposição?`);
        conversationState = 'FORWARD_TO_SALES';
      }
    }

    function showLoading() {
      const id = '__loading__';
      if (!document.getElementById(id)) {
        const n = htmlEl('Buscando <span class="spinner" aria-hidden="true"></span>');
        n.id = id; chatMessages.appendChild(n); chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    }
    function hideLoading() { const el = document.getElementById('__loading__'); if (el) el.remove(); }

    // Mecanismo de busca: usa google.script.run se disponível; senão, carrega CSV local/endpoint
    async function searchProductsRemote(term) {
      if (isAppsScript) {
        return new Promise((resolve, reject) => {
          showLoading();
          google.script.run.withSuccessHandler(results => { hideLoading(); resolve(results || []); })
                         .withFailureHandler(err => { hideLoading(); reject(err); })
                         .searchStock(term);
        });
      } else {
        // Busca em CSV local e faz filtro simples
        showLoading();
        try {
          const res = await fetch(CSV_PATH);
          if (!res.ok) throw new Error('Falha ao carregar CSV: ' + res.status);
          const txt = await res.text();
          hideLoading();
          const parsed = parseCSV(txt); // retorna array de objetos
          const q = term.trim().toLowerCase();
          const results = parsed.filter(row => {
            return [row.Nome_Produto, row.PN_Alternativos, row.Modelos, row.Medidas].join(' ').toLowerCase().includes(q);
          });
          return results;
        } catch (err) {
          hideLoading();
          console.error(err);
          return [];
        }
      }
    }

    async function createLeadRemote(payload) {
      if (isAppsScript) {
        return new Promise((resolve, reject) => {
          google.script.run.withSuccessHandler(res=>resolve(res)).withFailureHandler(err=>reject(err)).createLead(payload);
        });
      } else {
        // Em hospedagem estática não temos escrita por padrão — retorna falso/ok para frontend
        return { ok: false, info: 'Hospedagem estática: createLead não disponível' };
      }
    }

    function parseCSV(text) {
      const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
      if (lines.length === 0) return [];
      const header = lines[0].split(';').map(h=>h.trim());
      const rows = lines.slice(1).map(l => {
        const cells = l.split(';').map(c=>c.trim());
        const obj = {};
        for (let i=0;i<header.length;i++) obj[header[i] || ('col'+i)] = cells[i] || '';
        return obj;
      });
      return rows;
    }

    async function processInput(input) {
      userSay(input);
      chatInput.value = '';
      switch (conversationState) {
        case 'START':
          userData.nome = input; botSay(`Prazer, ${userData.nome}! Para agilizar, qual seu celular com DDD?`); conversationState='GET_CELULAR'; break;
        case 'GET_CELULAR':
          userData.celular = input; botSay('Obrigado! Do que você precisa hoje? Diga o nome, PN ou modelo.'); conversationState='GET_PRODUCT'; break;
        case 'GET_PRODUCT':
          botSay('Buscando...');
          try {
            const results = await searchProductsRemote(input);
            if (!results || results.length === 0) {
              botSay(`Não encontrei essa peça com "${input}". Vou criar um bilhete para que um vendedor verifique.` );
              await createLeadRemote({
                nome: userData.nome, celular: userData.celular, produto_busca: input, produto_pn:'', produto_nome:'', pagamento:'', status:'Contato requerido - busca manual'
              });
              conversationState = 'ENDED';
            } else if (results.length === 1) {
              lastFoundProducts = results; processProductSelection(results[0]);
            } else {
              lastFoundProducts = results; botSay(`Encontrei ${results.length} itens. Veja abaixo e clique em "Selecionar":`); results.forEach((p,i)=>renderProductCard(p,i)); conversationState='CHOOSE_FROM_LIST';
            }
          } catch (err) { console.error(err); botSay('Erro ao consultar o servidor.'); }
          break;
        case 'CHOOSE_FROM_LIST':
          const n = parseInt(input,10);
          if (!isNaN(n) && n>0 && n<=lastFoundProducts.length) processProductSelection(lastFoundProducts[n-1]); else botSay('Digite o número ou clique em "Selecionar".');
          break;
        case 'CONFIRM_ORCAMENTO':
          if (input.toLowerCase().startsWith('s')) { botSay('Qual a forma de pagamento (Pix, Cartão, Boleto)?'); conversationState='GET_PAYMENT'; }
          else { botSay('Tudo bem. Se precisar de outra peça, pode me chamar.'); conversationState='GET_PRODUCT'; }
          break;
        case 'GET_PAYMENT':
          const pagamento = input;
          botSay('Criando bilhete para o vendedor...');
          try {
            await createLeadRemote({ nome:userData.nome, celular:userData.celular, produto_busca:'', produto_pn:userData.produto?.PN_Alternativos||'', produto_nome:userData.produto?.Nome_Produto||'', pagamento, status:'Orçamento solicitado' });
            botSay(`Bilhete criado. Um vendedor entrará em contato no ${userData.celular}.`);
            conversationState='ENDED';
          } catch (err) { console.error(err); botSay('Erro ao criar bilhete.'); }
          break;
        case 'FORWARD_TO_SALES':
          botSay('Direcionando seu contato para um vendedor...'); conversationState='ENDED'; break;
        default:
          botSay('Se quiser continuar, diga o que precisa.'); conversationState='GET_PRODUCT';
      }
    }

    chatForm.addEventListener('submit', e=>{ e.preventDefault(); const t = chatInput.value.trim(); if (t) processInput(t); });
    // inicia
    botSay('Olá! Sou o assistente de vendas da MD TURBOS. Para começarmos, qual o seu nome?');
  </script>
</body>
</html>
